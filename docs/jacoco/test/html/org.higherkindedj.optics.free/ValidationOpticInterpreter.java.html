<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidationOpticInterpreter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hkj-core</a> &gt; <a href="index.source.html" class="el_package">org.higherkindedj.optics.free</a> &gt; <span class="el_source">ValidationOpticInterpreter.java</span></div><h1>ValidationOpticInterpreter.java</h1><pre class="source lang-java linenums">// Copyright (c) 2025 Magnus Smith
// Licensed under the MIT License. See LICENSE.md in the project root for license information.
package org.higherkindedj.optics.free;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.function.Function;
import org.higherkindedj.hkt.Kind;
import org.higherkindedj.hkt.free.Free;
import org.higherkindedj.hkt.id.Id;
import org.higherkindedj.hkt.id.IdKind;
import org.higherkindedj.hkt.id.IdMonad;
import org.higherkindedj.optics.util.Traversals;
import org.jspecify.annotations.NullMarked;

/**
 * Validation interpreter for optic programs that validates operations during execution.
 *
 * &lt;p&gt;This interpreter executes optic operations while collecting validation warnings and errors.
 * Note that operations are executed to enable proper flatMap chaining in Free programs, but the
 * validation results provide insight into potential issues. This is useful for:
 *
 * &lt;ul&gt;
 *   &lt;li&gt;Validating operations before execution
 *   &lt;li&gt;Checking constraints and invariants
 *   &lt;li&gt;Testing program structure
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Example:
 *
 * &lt;pre&gt;{@code
 * Free&lt;OpticOpKind.Witness, Person&gt; program = ...;
 * ValidationOpticInterpreter interpreter = new ValidationOpticInterpreter();
 * ValidationResult result = interpreter.validate(program);
 *
 * if (result.isValid()) {
 *     // Safe to execute
 *     Person updated = new DirectOpticInterpreter().run(program);
 * } else {
 *     System.err.println(&quot;Validation failed:&quot;);
 *     result.errors().forEach(System.err::println);
 * }
 * }&lt;/pre&gt;
 */
@NullMarked
<span class="fc" id="L48">public final class ValidationOpticInterpreter {</span>
<span class="fc" id="L49">  private final List&lt;String&gt; errors = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L50">  private final List&lt;String&gt; warnings = new ArrayList&lt;&gt;();</span>

  /**
   * Validates an optic program by executing it and collecting validation results.
   *
   * &lt;p&gt;The program is executed to enable proper flatMap chaining, while validation checks are
   * performed on SET and MODIFY operations.
   *
   * @param program The Free monad program to validate
   * @param &lt;A&gt; The result type
   * @return A validation result containing any errors and warnings
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public &lt;A&gt; ValidationResult validate(Free&lt;OpticOpKind.Witness, A&gt; program) {
<span class="fc" id="L64">    errors.clear();</span>
<span class="fc" id="L65">    warnings.clear();</span>

    // Natural transformation from OpticOp to Id monad
    // We must execute operations to get proper results for flatMap chaining,
    // while also performing validation checks
<span class="fc" id="L70">    Function&lt;Kind&lt;OpticOpKind.Witness, ?&gt;, Kind&lt;IdKind.Witness, ?&gt;&gt; transform =</span>
        kind -&gt; {
<span class="fc" id="L72">          OpticOp&lt;?, ?&gt; op = OpticOpKindHelper.OP.narrow((Kind&lt;OpticOpKind.Witness, Object&gt;) kind);</span>

          // Validate and execute each operation
          // If execution fails, return the source unchanged to allow chaining to continue
          Object result =
<span class="fc bfc" id="L77" title="All 10 branches covered.">              switch (op) {</span>
<span class="fc" id="L78">                case OpticOp.Get&lt;?, ?&gt; get -&gt; executeGet(get);</span>
<span class="fc" id="L79">                case OpticOp.Preview&lt;?, ?&gt; preview -&gt; executePreview(preview);</span>
<span class="fc" id="L80">                case OpticOp.GetAll&lt;?, ?&gt; getAll -&gt; executeGetAll(getAll);</span>
<span class="fc" id="L81">                case OpticOp.Set&lt;?, ?&gt; set -&gt; {</span>
<span class="fc" id="L82">                  validateSet(set);</span>
<span class="fc" id="L83">                  yield safeExecuteSet(set);</span>
                }
<span class="fc" id="L85">                case OpticOp.SetAll&lt;?, ?&gt; setAll -&gt; {</span>
<span class="fc" id="L86">                  validateSetAll(setAll);</span>
<span class="fc" id="L87">                  yield safeExecuteSetAll(setAll);</span>
                }
<span class="fc" id="L89">                case OpticOp.Modify&lt;?, ?&gt; modify -&gt; {</span>
<span class="fc" id="L90">                  validateModify(modify);</span>
<span class="fc" id="L91">                  yield safeExecuteModify(modify);</span>
                }
<span class="fc" id="L93">                case OpticOp.ModifyAll&lt;?, ?&gt; modifyAll -&gt; safeExecuteModifyAll(modifyAll);</span>
<span class="fc" id="L94">                case OpticOp.Exists&lt;?, ?&gt; exists -&gt; executeExists(exists);</span>
<span class="fc" id="L95">                case OpticOp.All&lt;?, ?&gt; all -&gt; executeAll(all);</span>
<span class="fc" id="L96">                case OpticOp.Count&lt;?, ?&gt; count -&gt; executeCount(count);</span>
<span class="fc" id="L97">              };</span>

<span class="fc" id="L99">          return Id.of(Free.pure(result));</span>
        };

    // Execute the program with validation
<span class="fc" id="L103">    program.foldMap(transform, IdMonad.instance());</span>

<span class="fc" id="L105">    return new ValidationResult(</span>
<span class="fc" id="L106">        Collections.unmodifiableList(new ArrayList&lt;&gt;(errors)),</span>
<span class="fc" id="L107">        Collections.unmodifiableList(new ArrayList&lt;&gt;(warnings)));</span>
  }

  // Note: These validate methods don't need @SuppressWarnings(&quot;unchecked&quot;) because
  // Java's sealed types + switch expressions correctly infer type parameters from
  // the pattern-matched OpticOp&lt;?, ?&gt; cases.

  private &lt;S, A&gt; void validateSet(OpticOp.Set&lt;S, A&gt; op) {
    // Example validation: could check if value is null, out of range, etc.
<span class="fc bfc" id="L116" title="All 2 branches covered.">    if (op.newValue() == null) {</span>
<span class="fc" id="L117">      warnings.add(&quot;SET operation with null value: &quot; + op.optic());</span>
    }
<span class="fc" id="L119">  }</span>

  private &lt;S, A&gt; void validateSetAll(OpticOp.SetAll&lt;S, A&gt; op) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">    if (op.newValue() == null) {</span>
<span class="fc" id="L123">      warnings.add(&quot;SET_ALL operation with null value: &quot; + op.optic());</span>
    }
<span class="fc" id="L125">  }</span>

  private &lt;S, A&gt; void validateModify(OpticOp.Modify&lt;S, A&gt; op) {
    // Could validate that modifier doesn't return null
    try {
<span class="fc" id="L130">      A currentValue = op.optic().get(op.source());</span>
<span class="fc" id="L131">      A newValue = op.modifier().apply(currentValue);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">      if (newValue == null) {</span>
<span class="fc" id="L133">        warnings.add(&quot;MODIFY operation produced null value: &quot; + op.optic());</span>
      }
<span class="fc" id="L135">    } catch (Exception e) {</span>
<span class="fc" id="L136">      errors.add(&quot;MODIFY operation failed: &quot; + op.optic() + &quot; - &quot; + e.getMessage());</span>
<span class="fc" id="L137">    }</span>
<span class="fc" id="L138">  }</span>

  // Execute methods - these perform the actual operations to enable proper flatMap chaining

  private &lt;S, A&gt; A executeGet(OpticOp.Get&lt;S, A&gt; op) {
<span class="fc" id="L143">    return op.optic().get(op.source());</span>
  }

  private &lt;S, A&gt; Optional&lt;A&gt; executePreview(OpticOp.Preview&lt;S, A&gt; op) {
<span class="fc" id="L147">    return op.optic().preview(op.source());</span>
  }

  private &lt;S, A&gt; List&lt;A&gt; executeGetAll(OpticOp.GetAll&lt;S, A&gt; op) {
<span class="fc" id="L151">    return op.optic().getAll(op.source());</span>
  }

  private &lt;S, A&gt; S safeExecuteSet(OpticOp.Set&lt;S, A&gt; op) {
    try {
<span class="fc" id="L156">      return op.optic().set(op.newValue(), op.source());</span>
<span class="fc" id="L157">    } catch (Exception e) {</span>
<span class="fc" id="L158">      errors.add(&quot;SET operation failed: &quot; + op.optic() + &quot; - &quot; + e.getMessage());</span>
<span class="fc" id="L159">      return op.source();</span>
    }
  }

  private &lt;S, A&gt; S safeExecuteSetAll(OpticOp.SetAll&lt;S, A&gt; op) {
    try {
<span class="fc" id="L165">      return Traversals.modify(op.optic(), ignored -&gt; op.newValue(), op.source());</span>
<span class="fc" id="L166">    } catch (Exception e) {</span>
<span class="fc" id="L167">      errors.add(&quot;SET_ALL operation failed: &quot; + op.optic() + &quot; - &quot; + e.getMessage());</span>
<span class="fc" id="L168">      return op.source();</span>
    }
  }

  private &lt;S, A&gt; S safeExecuteModify(OpticOp.Modify&lt;S, A&gt; op) {
    try {
<span class="fc" id="L174">      return op.optic().modify(op.modifier(), op.source());</span>
<span class="fc" id="L175">    } catch (Exception e) {</span>
<span class="fc" id="L176">      errors.add(&quot;MODIFY operation failed: &quot; + op.optic() + &quot; - &quot; + e.getMessage());</span>
<span class="fc" id="L177">      return op.source();</span>
    }
  }

  private &lt;S, A&gt; S safeExecuteModifyAll(OpticOp.ModifyAll&lt;S, A&gt; op) {
    try {
<span class="fc" id="L183">      return Traversals.modify(op.optic(), op.modifier(), op.source());</span>
<span class="fc" id="L184">    } catch (Exception e) {</span>
<span class="fc" id="L185">      errors.add(&quot;MODIFY_ALL operation failed: &quot; + op.optic() + &quot; - &quot; + e.getMessage());</span>
<span class="fc" id="L186">      return op.source();</span>
    }
  }

  private &lt;S, A&gt; Boolean executeExists(OpticOp.Exists&lt;S, A&gt; op) {
<span class="fc" id="L191">    return op.optic().exists(op.predicate(), op.source());</span>
  }

  private &lt;S, A&gt; Boolean executeAll(OpticOp.All&lt;S, A&gt; op) {
<span class="fc" id="L195">    return op.optic().all(op.predicate(), op.source());</span>
  }

  private &lt;S, A&gt; Integer executeCount(OpticOp.Count&lt;S, A&gt; op) {
<span class="fc" id="L199">    return op.optic().length(op.source());</span>
  }

  /**
   * Result of validation containing errors and warnings.
   *
   * @param errors List of validation errors (program should not execute if non-empty)
   * @param warnings List of validation warnings (program can execute but be careful)
   */
<span class="fc" id="L208">  public record ValidationResult(List&lt;String&gt; errors, List&lt;String&gt; warnings) {</span>
    /**
     * Checks if the program is valid (no errors).
     *
     * @return true if there are no errors
     */
    public boolean isValid() {
<span class="fc" id="L215">      return errors.isEmpty();</span>
    }

    /**
     * Checks if the program has warnings.
     *
     * @return true if there are warnings
     */
    public boolean hasWarnings() {
<span class="fc bfc" id="L224" title="All 2 branches covered.">      return !warnings.isEmpty();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>