<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hkj-core</a> &gt; <a href="index.source.html" class="el_package">org.higherkindedj.hkt.context</a> &gt; <span class="el_source">RequestContext.java</span></div><h1>RequestContext.java</h1><pre class="source lang-java linenums">// Copyright (c) 2025 Magnus Smith
// Licensed under the MIT License. See LICENSE.md in the project root for license information.
package org.higherkindedj.hkt.context;

import java.time.Instant;
import java.util.Base64;
import java.util.Locale;
import java.util.concurrent.ThreadLocalRandom;

/**
 * Pre-defined {@link ScopedValue} instances for common HTTP request context values.
 *
 * &lt;p&gt;{@code RequestContext} provides a standard set of scoped values for request tracing,
 * correlation, localisation, multi-tenancy, and timing. These values propagate automatically to
 * child virtual threads forked within the same scope.
 *
 * &lt;p&gt;&lt;b&gt;Usage Example:&lt;/b&gt;
 *
 * &lt;pre&gt;{@code
 * // At the request handler entry point
 * public Response handleRequest(HttpRequest request) {
 *     return ScopedValue
 *         .where(RequestContext.TRACE_ID, request.header(&quot;X-Trace-ID&quot;).orElse(generateTraceId()))
 *         .where(RequestContext.LOCALE, parseLocale(request))
 *         .where(RequestContext.REQUEST_TIME, Instant.now())
 *         .call(() -&gt; processRequest(request));
 * }
 *
 * // Deep in the call stack
 * public void logOperation(String operation) {
 *     String traceId = RequestContext.TRACE_ID.get();
 *     logger.info(&quot;[{}] {}&quot;, traceId, operation);
 * }
 * }&lt;/pre&gt;
 *
 * &lt;p&gt;&lt;b&gt;Design Note:&lt;/b&gt; This is a utility class with static {@link ScopedValue} fields rather than
 * a bundled record. This design provides flexibility (bind only what you need), granularity
 * (different components can read different values), and natural composition with {@link
 * ScopedValue#where}.
 *
 * @see Context
 * @see SecurityContext
 * @see ScopedValue
 */
public final class RequestContext {

  private RequestContext() {
    // Utility class - no instantiation
  }

  /**
   * Unique identifier for distributed tracing.
   *
   * &lt;p&gt;Typically generated at the edge (API gateway, load balancer) and propagated through all
   * downstream services via HTTP headers (e.g., {@code X-Trace-ID}).
   */
<span class="fc" id="L57">  public static final ScopedValue&lt;String&gt; TRACE_ID = ScopedValue.newInstance();</span>

  /**
   * Correlation ID linking related requests.
   *
   * &lt;p&gt;Used to group requests that are part of the same user action or business transaction, even
   * across separate trace trees. Often propagated via {@code X-Correlation-ID} header.
   */
<span class="fc" id="L65">  public static final ScopedValue&lt;String&gt; CORRELATION_ID = ScopedValue.newInstance();</span>

  /**
   * User's preferred locale for response formatting.
   *
   * &lt;p&gt;Influences date formats, number formats, currency symbols, and message translations.
   * Typically extracted from the {@code Accept-Language} header.
   */
<span class="fc" id="L73">  public static final ScopedValue&lt;Locale&gt; LOCALE = ScopedValue.newInstance();</span>

  /**
   * Tenant identifier for multi-tenant applications.
   *
   * &lt;p&gt;Determines which tenant's data, configuration, and resources to use. May be extracted from
   * headers, subdomains, or path prefixes.
   */
<span class="fc" id="L81">  public static final ScopedValue&lt;String&gt; TENANT_ID = ScopedValue.newInstance();</span>

  /**
   * Timestamp when the request was received.
   *
   * &lt;p&gt;Useful for timeout calculations, latency measurement, and audit logging. Should be set at
   * the earliest point in request processing.
   */
<span class="fc" id="L89">  public static final ScopedValue&lt;Instant&gt; REQUEST_TIME = ScopedValue.newInstance();</span>

  /**
   * Request deadline for timeout propagation.
   *
   * &lt;p&gt;Operations should check this and fail fast if the deadline has passed. Enables consistent
   * timeout behaviour across the entire request processing chain.
   */
<span class="fc" id="L97">  public static final ScopedValue&lt;Instant&gt; DEADLINE = ScopedValue.newInstance();</span>

  // ===== HELPER METHODS =====

  /**
   * Generates a compact, URL-safe trace ID.
   *
   * &lt;p&gt;The generated ID is 16 characters, using Base64 URL-safe encoding without padding. Suitable
   * for use in HTTP headers and logging.
   *
   * @return A new unique trace ID.
   */
  public static String generateTraceId() {
<span class="fc" id="L110">    byte[] bytes = new byte[12];</span>
<span class="fc" id="L111">    ThreadLocalRandom.current().nextBytes(bytes);</span>
<span class="fc" id="L112">    return Base64.getUrlEncoder().withoutPadding().encodeToString(bytes);</span>
  }

  /**
   * Generates a trace ID with a timestamp prefix.
   *
   * &lt;p&gt;Format: {@code {timestamp-hex}-{random-hex}}. Enables rough time-based sorting of traces.
   *
   * @return A new timestamped trace ID.
   */
  public static String generateTimestampedTraceId() {
<span class="fc" id="L123">    long timestamp = System.currentTimeMillis();</span>
<span class="fc" id="L124">    long random = ThreadLocalRandom.current().nextLong();</span>
<span class="fc" id="L125">    return String.format(&quot;%012x-%08x&quot;, timestamp, random &amp; 0xFFFFFFFFL);</span>
  }

  /**
   * Returns the current trace ID, or a default value if not bound.
   *
   * @param defaultValue The value to return if TRACE_ID is not bound.
   * @return The current trace ID or the default.
   */
  public static String getTraceIdOrDefault(String defaultValue) {
<span class="fc bfc" id="L135" title="All 2 branches covered.">    return TRACE_ID.isBound() ? TRACE_ID.get() : defaultValue;</span>
  }

  /**
   * Returns the current locale, or a default if not bound.
   *
   * @param defaultLocale The locale to return if LOCALE is not bound.
   * @return The current locale or the default.
   */
  public static Locale getLocaleOrDefault(Locale defaultLocale) {
<span class="fc bfc" id="L145" title="All 2 branches covered.">    return LOCALE.isBound() ? LOCALE.get() : defaultLocale;</span>
  }

  /**
   * Returns the current tenant ID, or a default if not bound.
   *
   * @param defaultTenant The tenant ID to return if TENANT_ID is not bound.
   * @return The current tenant ID or the default.
   */
  public static String getTenantIdOrDefault(String defaultTenant) {
<span class="fc bfc" id="L155" title="All 2 branches covered.">    return TENANT_ID.isBound() ? TENANT_ID.get() : defaultTenant;</span>
  }

  /**
   * Checks if the request deadline has been exceeded.
   *
   * @return {@code true} if DEADLINE is bound and the current time is after the deadline.
   */
  public static boolean isDeadlineExceeded() {
<span class="fc bfc" id="L164" title="All 4 branches covered.">    return DEADLINE.isBound() &amp;&amp; Instant.now().isAfter(DEADLINE.get());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>